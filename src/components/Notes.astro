---
import path from "path";

export const notesPath = path.join(process.cwd(), "notes");
export function getSlugForNote(note) {
  return (note.file || "")
      .replace(notesPath, "") // remove local path
      .replace(/\.md$/, "") // remove .md extension
      .toLowerCase().replace(/\s/g, '-')  // replace spaces with -
      .split("").filter(c => "()%".indexOf(c) == -1).join("") // remove some chars
      .replace(/_readme$/, "") // treat _readme.md like an index.html
      ;
}
export function getTypeForNote(note) {
  const slug = getSlugForNote(note);
  return slug.substring(1, slug.indexOf("/", 1))
}
export function getNameForNote(note) {
  const slug = getSlugForNote(note);
  return slug.substring(getTypeForNote(note).length+1);
}
export function getPubDateForNote(note) {
  if (note.params?.pubDate) return note.params.pubDate;
  if (note.frontmatter?.pubDate) return note.frontmatter.pubDate;
  if (note.frontmatter?.finishedDate) return note.frontmatter.finishedDate;
  // TODO: make extensible to other types too
  return ""; // What should the default be here? Anything without a date is published?
}

export async function getNotes(options?: { keepIf?: (note: any) => boolean }) {
  // Get all notes recursively from the notes directory
  const notes = await Astro.glob("../../notes/**/*.md");
  const nowDate = new Date();

  // Convert notes to more usable type, and sort them
  let results: any[] = []; // TODO: define type
  for (const note of notes) {
    const slug = getSlugForNote(note);
    const type = getTypeForNote(note)
    const name = getNameForNote(note);
    const pubDate = getPubDateForNote(note);
    const isDraft = ''+(new Date(pubDate) > nowDate);

    results.push({ params: { slug, type, name, pubDate, isDraft }, props: note });
  }

  if (process.env.NODE_ENV === 'production') {
    // Exclude (non index) draft posts
    results = results.filter((note) => note.params.isDraft !== 'true' || /readme.md$/.test(note.props.file))
  }

  // Sort by date
  results.sort((a, b) => {
    return new Date(b.params.pubDate).getTime() - new Date(a.params.pubDate).getTime()
  });
  //console.log(results.filter(note=>note.params.type=="books").slice(0,10).map((note) => note.params.pubDate+': '+note.params.name).join("\n"));
  //console.log(results.filter(note=>note.params.type=="books").map((note) => note.params.pubDate).join("', \n'"));

  // Remove by custom filter
  if (options?.keepIf) {
    results = results.filter(options.keepIf);
  }

  // console.log("getNotes", results)  
  return results;
}

// TODO: is this even used?
const notes = await getNotes().then((notes) =>
  notes.map((item) => {
    const slug = item.params.slug;
    // const tags = getTagsFromSource(item.props);
    return {
      article: item.props,
      slug,
      // tags,
    };
  })
);
